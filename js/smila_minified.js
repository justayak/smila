window.Smila=function(){function t(){}function Y(a,b,c,d,e,f,p,g){var l=null;Array.isArray(a)&&(l=a[1],a=a[0]);for(var k=0;k<b.length;k++)for(var n=0;n<b[0].length;n++)for(var h=b[k][n].getContext("2d"),m=0,q=0,r=k*p;r<(k+1)*p-1;r+=d){for(var q=0,s=n*g;s<(n+1)*g-1;s+=e){var t=s/e*f+r/d;t<a.data.length&&(c.position(m,q),c.setTile(a.data[t])&&c.render(h),null!==l&&c.setTile(l.data[t])&&c.render(h));q+=e}m+=d}}var Z="",$={r:255,g:0,b:0,a:255},aa,na=Math.floor(1E3/60);t.Settings=function(a){Z=a.imagePath||
    "";$=a.defaultOutlineColor||{r:255,g:0,b:0,a:255};aa=a.verbose||!1};var q=t.Sprite=function(a,b){this.img=a;this.frameHeight=b.h;this.frameWidth=b.w;!0==b.o&&(this.imgOutlined=m[b.key+"_outline"].canvas);this.bitmask=b.bm?m[b.key+"_bitmask"]:null;this.oy=this.ox=0;this.zIndexByYPos=!0;this.z=this.y=this.x=0;this.mouseLeave=this.mouseEnter=null;this._outline=this._mouseIsActive=!1;this.angleInRadians=0};q.prototype.onmouseenter=function(a){this._mouseIsActive=!0;this.mouseEnter=a;return this};q.prototype.onmouseleave=
    function(a){this._mouseIsActive=!0;this.mouseLeave=a;return this};q.prototype.outline=function(a){this._outline=a;return this};q.prototype.subimage=function(a,b){this.ox=a;this.oy=b;return this};q.prototype.position=function(a,b){return 0<arguments.length?(this.x=a,this.y=b,this):{x:this.x,y:this.y}};q.prototype.toCanvas=function(){var a=document.createElement("canvas");a.height=this.frameHeight;a.width=this.frameWidth;var b=a.getContext("2d"),c=this.x,d=this.y;this.y=this.x=0;this.render(b);this.x=
    c;this.y=d;return a};q.prototype.toBase64=function(){return this.img.toDataURL()};q.prototype.render=function(a){if(this._mouseIsActive&&(null!==this.mouseEnter||null!==this.mouseLeave)){var b;b=null!==w?{x:w.realPosition.x+D.x,y:w.realPosition.y+D.y}:D;var c=!1;b.x>=this.x&&b.y>=this.y&&b.x<=this.x+this.frameWidth&&b.y<=this.y+this.frameHeight&&(null===this.bitmask?c=!0:this.isPixel(b.x,b.y)&&(c=!0));b.x&&this._mouseIsOver!==c&&(c?null!==this.mouseEnter&&this.mouseEnter.call(this):null!==this.mouseLeave&&
    this.mouseLeave.call(this),this._mouseIsOver=c)}b=this.ox*this.frameWidth;var c=this.oy*this.frameHeight,d=0.5+this.x<<0,e=0.5+this.y<<0;this.zIndexByYPos&&(this.z=e+this.frameHeight/2);a.translate(d,e);a.rotate(this.angleInRadians);this._outline?a.drawImage(this.imgOutlined,b,c,this.frameWidth,this.frameHeight,0,0,this.frameWidth,this.frameHeight):a.drawImage(this.img,b,c,this.frameWidth,this.frameHeight,0,0,this.frameWidth,this.frameHeight);a.rotate(-this.angleInRadians);a.translate(-d,-e)};q.prototype.isPixel=
    function(a,b){return this.bitmask.test(a-this.x+this.ox*this.frameWidth,b-this.y+this.oy*this.frameHeight)};var y=function(a,b,c){q.call(this,a,b);this.spriteData=b;this.firstgid=c;this.tileSetWidth=a.width/b.w};y.prototype=Object.create(q.prototype);y.prototype.setTile=function(a){if(0===a)return!1;if(a>=this.firstgid){var b=0===a%this.tileSetWidth,c=Math.floor((a-(this.firstgid-1))/this.tileSetWidth);b&&(c-=1);this.subimage(b?this.tileSetWidth-1:a%this.tileSetWidth-1,c);return!0}return!1};y.prototype.splice=
    function(){return new y(this.img,this.spriteData,this.firstgid)};var r=t.Animation=function(a,b,c,d,e){q.call(this,a,b);this.animations=c;this.durationPerStepInMs=d;a="undefined"===typeof e?r.Type.ONCE:e;this.pointer=0;this.isStoped=!0;this.elapsedTime=0;this.forward=!0;switch(a){case r.Type.BOUNCE:this.subupdate=ba;break;case r.Type.ENDLESS:this.subupdate=ca;break;case r.Type.ONCE:this.subupdate=da}};r.prototype=Object.create(q.prototype);r.prototype.play=function(){this.isStoped=!1;return this};
    r.prototype.pause=function(){this.isStoped=!0;return this};r.prototype.reset=function(){this.isStoped=!0;this.pointer=0;return this};r.prototype.update=function(a,b){if(!this.isStoped)if(1===this.animations.length)this.subimage(this.animations[0].x,this.animations[0].y);else{if(this.elapsedTime>this.durationPerStepInMs){this.elapsedTime=0;this.subupdate();var c=this.animations[this.pointer];this.subimage(c.x,c.y)}this.elapsedTime+=b}};var da=function(){this.pointer<this.animations.length-1&&(this.pointer+=
        1)},ca=function(){this.pointer=this.pointer<this.animations.length-1?this.pointer+1:0},ba=function(){0==this.pointer?this.forward=!0:this.pointer===this.animations.length-1&&(this.forward=!1);this.pointer=this.forward?this.pointer+1:this.pointer-1};r.Type={BOUNCE:0,ONCE:1,ENDLESS:2};var E=t.Entity=function(a,b,c){q.call(this,a,b);this.animations=[];this.pointer=this.elapsedTime=this.durationPerStepInMs=0;this.currentState="";this.allanimations=c;this.updateCallback=null;this.subupdate=function(){}};
    E.prototype=Object.create(q.prototype);E.prototype.onUpdate=function(a){this.updateCallback=a;return this};E.prototype.animate=function(a){if(a!==this.currentState){var b=this.allanimations[a];if(b)switch(this.currentState=a,this.pointer=0,this.animations=b.anims,this.durationPerStepInMs=b.durationPerFrame,b.type){case r.Type.BOUNCE:this.subupdate=ba;break;case r.Type.ENDLESS:this.subupdate=ca;break;case r.Type.ONCE:this.subupdate=da}return this}};E.prototype.update=function(a,b){null!==this.updateCallback&&
    this.updateCallback.call(this,a,b);if(0!==this.animations.length)if(1===this.animations.length)this.subimage(this.animations[0].x,this.animations[0].y);else{if(this.elapsedTime>this.durationPerStepInMs){this.elapsedTime=0;this.subupdate();var c=this.animations[this.pointer];this.subimage(c.x,c.y)}this.elapsedTime+=b}};var z=t.Map=function(a,b){var c=!0;this.tilesets=[];this.subtiles=[];this.subtilesTop=[];this.currentY=this.currentX=0;this.currentLY=this.currentLX=1;this.subtileWidth=100*a.tilewidth;
        this.subtileHeight=100*a.tileheight;var d=Math.ceil(a.width*a.tilewidth/this.subtileWidth),e=Math.ceil(a.height*a.tileheight/this.subtileHeight);s("[Smila::Map->Ctor] create subs: "+d+" x "+e+"  {"+this.subtileWidth+" x "+this.subtileHeight+"} per Element");for(var f=0;f<d;f++){this.subtiles[f]=[];this.subtilesTop[f]=[];for(var p=0;p<e;p++){var g=document.createElement("canvas");g.width=this.subtileWidth;g.height=this.subtileHeight;this.subtiles[f][p]=g;g=document.createElement("canvas");g.width=
            this.subtileWidth;g.height=this.subtileHeight;this.subtilesTop[f][p]=g}}for(var l=this,d=0;d<a.tilesets.length&&1>d;d++)if(e=a.tilesets[d].name,e in m)e=m[e],this.tileset=new y(e.canvas,e.meta,a.tilesets[0].firstgid),this.init(a);else{var k=a.tilesets[d],c=!1;ea.put({src:b.imgFolder+k.image.replace(/^.*[\\\/]/,""),w:k.tilewidth,h:k.tileheight,key:k.name},function(){var b=m[k.name];l.tileset=new y(b.canvas,b.meta,a.tilesets[0].firstgid);l.isready=!0;l.init(a)})}this.isready=c};z.prototype.renderBackground=
        function(a,b,c,d,e){b=Math.floor(b/this.subtileWidth);c=Math.floor(c/this.subtileHeight);e=c*this.subtileHeight+(this.subtileHeight-c%this.subtileHeight)+e;d=Math.ceil((b*this.subtileWidth+(this.subtileWidth-b%this.subtileWidth)+d)/this.subtileWidth);e=Math.ceil(e/this.subtileHeight);0>b&&(b=0);0>c&&(c=0);b>=d&&(d=b+1);c>=e&&(e=c+1);d=Math.min(d,this.subtiles.length);this.currentX=b;this.currentY=c;this.currentLX=d;for(this.currentLY=e;b<d;b++)for(var f=c;f<e;f++)null!==this.subtiles[b][f]?a.drawImage(this.subtiles[b][f],
            b*this.subtileWidth,f*this.subtileHeight):console.log("null at "+b+"|"+f)};z.prototype.renderTopLayer=function(a){for(var b=this.currentX,c=this.currentLX,d=this.currentLY;b<c;b++)for(var e=this.currentY;e<d;e++)null!==this.subtilesTop[b][e]?a.drawImage(this.subtilesTop[b][e],b*this.subtileWidth,e*this.subtileHeight):console.log("null at "+b+"|"+e)};z.prototype.onReady=function(a){if(this.isready)a();else{var b=this;setTimeout(function(){b.onReady(a)},100)}return this};z.prototype.init=function(a){var b=
        a.layers[3],c=a.layers[2];Y([a.layers[0],a.layers[1]],this.subtiles,this.tileset,a.tilewidth,a.tileheight,a.width,this.subtileWidth,this.subtileHeight);Y(b,this.subtilesTop,this.tileset,a.tilewidth,a.tileheight,a.width,this.subtileWidth,this.subtileHeight);for(var b=this.tileset,d=a.width,e=a.tilewidth,f=a.tileheight,p=[],g=0;g<c.data.length;g++){var l=c.data[g];if(0!==l){var k=b.splice();k.setTile(l);k.position(g%d*e,Math.floor(g/d)*f);p.push(k)}}this.sprites=p;s("[Smila::Map->init] load dynamic sprites onto map: {"+
        this.sprites.length+"}");if(4<a.layers.length&&1<a.tilesets.length){c=a.layers[4].data;b=a.tilesets[1].firstgid-1;d={};if(5<a.layers.length&&(g=a.tilewidth,l=a.tileheight,k=a.layers[5],"objectgroup"===k.type))for(e=0;e<k.objects.length;e++){var n=k.objects[e],f=Math.floor(n.x/g),p=Math.floor(n.y/l);d[f+"_"+p]={name:n.name,properties:n.properties}}this.eventLayer=[];for(f=0;f<a.width;f++)for(this.eventLayer[f]=[],p=0;p<a.height;p++)e=p*a.width+f,0===c[e]?this.eventLayer[f][p]=0:(g=f+"_"+p,l={},g in
        d&&(l=d[g]),this.eventLayer[f][p]={id:c[e]-b,data:l})}};var I=t.Camera=function(){this.offset={x:0,y:0};this.realPosition={x:0,y:0}};I.prototype.translate=function(a,b){this.offset.x=a;this.offset.y=b;0===a&&0===b?(this.realPosition.x=Math.round(this.realPosition.x),this.realPosition.y=Math.round(this.realPosition.y)):(this.realPosition.x-=a,this.realPosition.y-=b)};I.prototype.render=function(){x.translate(this.offset.x,this.offset.y)};I.prototype.set=function(a,b){this.translate(this.realPosition.x-
        a,this.realPosition.y-b);this.render();this.translate(0,0)};var m={},J={},w=null,ea=t.DataStore={putMap:function(a,b){if(a instanceof Array){var c=0,d=function(d){return function(f){if("string"===typeof f||f instanceof String)f=JSON.parse(f);c+=1;J[d.key]=new z(f,d);c===a.length&&b()}};a.forEach(function(a){fa(a,d(a))})}else fa(a,function(c){if("string"===typeof c||c instanceof String)c=JSON.parse(c);J[a.key]=new z(c,a);b()})},getMap:function(a){if(a in J)return J[a];throw"[Smila::DataStore->getMap] Cannot find key {"+
            a+"}";},put:function(a,b){if(a instanceof Array){var c=[];a.forEach(function(d){ga(d,function(){c.push(0);c.length===a.length&&b()},function(){throw"[Smila::Datastore->put] cannot put element into Datastore";})})}else ga(a,function(){b()},function(){throw"[Smila::Datastore->put] cannot put element into Datastore";});return ea},get:function(a){if(a in m)return a=m[a],new q(a.canvas,a.meta);throw"[Smila::DataStore->get] cannot find {"+a+"}";},getAnimation:function(a,b,c,d){if(a in m)return a=m[a],new r(a.canvas,
            a.meta,b,c,d);throw"[Smila::DataStore->getAnimation] cannot find {"+a+"}";},getEntity:function(a,b){if(a in m){var c=m[a];return new E(c.canvas,c.meta,b)}throw"[Smila::DataStore->getAnimation] cannot find {"+a+"}";}},F={},h=[],oa=0,v=null,ha=!1,K=null,O=-1,P=-1,u=null,x=null,D={x:-1,y:-1},ia=!1,ja,Q=[],A=0,G=0,L=0,M=0,B=0,R=0,S=0,ka=0,la=0,T=0,U=0,C=0,pa=function(){if(250>h.length)for(var a=1;a<h.length;a++){for(var b=h[a],c=a;1<c&&h[c-1].y>b.y;)h[c]=h[c-1],c--;h[c]=b}else{for(var d=Math.min(h.length-
            1,C+250),a=C;a<d;a++){b=h[a];for(c=a;1<c&&h[c-1].y>b.y;)h[c]=h[c-1],c--;h[c]=b}C+=Math.floor(125);C>h.length&&(C=1)}},V=t.Renderer={onUpdate:function(a){a.$smilaId=oa++;F[a.$smilaId]=a},offUpdate:function(a){if("$smilaId"in a)delete F[a.$smilaId];else throw"[Smila::DataStore->offUpdate] cannot find the ID for the callback given at {onCallback}";},onSortSprites:function(a){},reset:function(){F={};h=[];v=null;clearInterval(ja)},isRunning:function(){return ha},setMap:function(a){v=a;v.onReady(function(){for(var a=
            0;a<v.sprites.length;a++)h.push(v.sprites[a])});return this},add:function(a){h.push(a)},start:function(){s("[Smila::Renderer->start]");if(ia)throw"[Smila::Renderer->start] The Renderer is already started!";if(window.CanvasRenderingContext2D){h=[];var a=document.getElementById("smila");u=document.createElement("canvas");u.style.position="absolute";u.height=a.clientHeight;u.width=a.clientWidth;P=u.height;O=u.width;a.appendChild(u);u.onmousemove=function(a){var c=u.getBoundingClientRect();D.x=a.clientX-
            c.left;D.y=a.clientY-c.top};x=u.getContext("2d");aa&&"undefined"!==typeof Stats&&(K=new Stats,document.body.appendChild(K.domElement));requestAnimationFrame(this.update);ja=setInterval(pa,500);w=new I;s("[Smila::Renderer->start] = success")}else document.getElementById("smila").innerHTML="[smila] is not supported!",s("[Smila::Renderer->start] = failed");ia=ha=!0},camera:function(){return w},update:function(){L=(new Date).getTime();G=L-(V.time||L);V.time=L;M=G/na;A=w.realPosition.x;B=w.realPosition.y;
            S=O+20;R=P+20;ka=A-10;la=B-10;T=A+O;U=B+P;x.clearRect(ka,la,S,R);w.render();for(var a in F){var b=F[a];b.call(b,G,M)}null!==v&&v.renderBackground(x,A,B,S,R);for(a=0;a<h.length;a+=1)b=h[a],b.update&&b.update(M,G),(b.x+b.frameWidth|b.width)>=A&&b.x<=T&&(b.y+b.frameHeight|b.height)>=B&&b.y<=U&&b.render(x);for(a=0;a<Q.length;a++)Q[a].update(x,M,G,A,B,T,U);null!==v&&v.renderTopLayer(x);requestAnimationFrame(V.update);null!==K&&K.update()},createParticleEmitter:function(a){a=new W(a);Q.push(a);return a}},
        W=t.ParticleEmitter=function(a){var b="undefined"===typeof a?100:a.particleCount||100;this.point=a.point||a.p;this.velocity=a.velocity||a.v||{x:0,y:0};this.direction=a.dir||a.direction;this.spread=a.spread||a.s;this.emissionRate=a.emissionRate||a.e;this.lifetimeMs=a.lifetimeMs||a.ttl||1E4;this.color=a.color||"#99CCFF";this.totalLifetime=a.totalLifetime||a.tlt||null;this.colorPointer=this.elapsed=0;this.angle=Math.atan2(this.direction.y,this.direction.x);this.magnitude=Math.sqrt(this.direction.x*this.direction.x+
            this.direction.y*this.direction.y);b=new ArrayBuffer(28*b);this.view=new Float32Array(b);this.pointer=0;this.isActive="undefined"===typeof a.active?!0:a.active;this.particleCount=0};W.prototype.createParticle=function(a,b,c,d){this.pointer>=this.view.length&&(this.pointer=0);this.view[this.pointer]=a.x;this.view[this.pointer+1]=a.y;this.view[this.pointer+2]=b.x;this.view[this.pointer+3]=b.y;this.view[this.pointer+4]="undefined"!==typeof d?d.x:0;this.view[this.pointer+5]="undefined"!==typeof d?d.y:
        0;this.view[this.pointer+6]=c;a=this.pointer;this.particleCount+=1;this.pointer+=7;return a};W.prototype.update=function(a,b,c,d,e,f,p){if(this.isActive){if(null!==this.totalLifetime){if(0>this.totalLifetime){this.isActive=!1;return}this.totalLifetime-=c}Array.isArray(this.color)?(a.fillStyle=this.color[this.colorPointer],this.colorPointer=this.colorPointer===this.color.length?0:this.colorPointer+1):a.fillStyle=this.color;this.elapsed+=c;if(50<this.elapsed){var g=this.elapsed=0;for(b=0;b<this.emissionRate/
        2;b++)g=this.angle+this.spread-Math.random()*this.spread*2,this.createParticle(this.point,{x:this.magnitude*Math.cos(g),y:this.magnitude*Math.sin(g)},this.lifetimeMs)}var l=g=0,k=this.view;for(b=0;b<this.particleCount;b++)if(g=7*b,0<k[g+6]){l=b;k[g+6]-=c;var n=k,h=g,m=g+2;n[h]+=n[m];n[h+1]+=n[m+1];n=k;h=g+2;m=g+4;n[h]+=n[m];n[h+1]+=n[m+1];k[g]>=d&&k[g]<=f&&k[g+1]>=e&&k[g+1]<=p&&a.fillRect(k[g],k[g+1],2,2)}this.particleCount=l;this.point.x+=this.velocity.x;this.point.y+=this.velocity.y}};var N=function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   b){var c=a%8;0!==c&&(a=a+8-c);a=Math.ceil(a/8);c=new ArrayBuffer(a*b);this.data=new Uint8Array(c);this.bytePerRow=a|0;this.width=a;this.height=b};N.prototype.set=function(a,b){var c=this.bytePerRow*b,d=a/8,c=c+(d|d),d=this.data[c];this.data[c]=d|1<<a%8;return this};N.prototype.clear=function(a,b){var c=this.bytePerRow*b,d=a/8,c=c+(d|d),d=this.data[c];this.data[c]=d&~(1<<a%8);return this};N.prototype.test=function(a,b){var c=this.bytePerRow*b,d=a/8;return 0!=(this.data[c+(d|d)]&1<<a%8)};var fa=function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              b){s("[Smila::*->loadMap] ... start loading map ...");var c=new XMLHttpRequest;c.onreadystatechange=function(){4==c.readyState&&b(c.responseText)};c.open("GET",a.src,!0);c.send(null)},ga=function(a,b,c){s("[Smila::*->loadSprite] {"+a.key+"}");a.w=a.w||a.width;a.h=a.h||a.height;a.o=a.o||a.outline|0;a.bm=a.bm||a.bitmask|0;if("undefined"!==typeof a.outlineColor||"undefined"!==typeof a.ocol)a.ocol=a.outlineColor||a.ocol;var d=new Image;d.onload=function(){s("[Smila::*->loadSprite] Image is loaded {"+
        a.key+"}");var c=document.createElement("canvas");c.width=d.width;c.height=d.height;var f=c.getContext("2d");f.drawImage(d,0,0);m[a.key]={meta:a,canvas:c};if(a.o){var h=a.key+"_outline";if(!(h in m)){var g=document.createElement("canvas");g.width=d.width;g.height=d.height;var l=g.getContext("2d");l.drawImage(c,0,0);var c=l.getImageData(0,0,d.width,d.height),k=a.ocol||$,c=ma(d.width,d.height,c,k),c=ma(d.width,d.height,c,k);l.putImageData(c,0,0);m[h]={meta:a,canvas:g}}}if(a.bm&&(h=a.key+"_bitmask",
        !(h in m))){g=new N(d.width,d.height);c=f.getImageData(0,0,d.width,d.height);for(f=0;f<d.width;f++)for(l=0;l<d.height;l++)0!==H(c,f,l).a&&g.set(f,l);m[h]=g}b()};d.onerror=function(){s("[Smila::*->loadSprite] Could not load Image {"+a.key+"}");c()};a.key in m?(s("[Smila::*->loadSprite] load from Cache: {"+a.key+"}"),b()):void 0!==a.base64?(s("[Smila::*->loadSprite] load from base64: {"+a.key+"}"),d.src=a.base64):(s("[Smila::*->loadSprite] load from URL: {"+a.key+"} {"+a.src+"}"),d.src=Z+a.src)},X=
        function(a,b,c,d,e,f,h){b=4*(b+c*a.width);a.data[b+0]=d;a.data[b+1]=e;a.data[b+2]=f;a.data[b+3]=h},H=function(a,b,c){b=4*(b+c*a.width);return{r:a.data[b+0],g:a.data[b+1],b:a.data[b+2],a:a.data[b+3]}},ma=function(a,b,c,d){for(var e=1;e<=b;e++)for(var f=1;f<=a;f++)if(0===H(c,f,e).a){var h=1!=f,g=f!=a-1;e!=b-1&&0!==H(c,f,e+1).a?X(c,f,e,d.r,d.g,d.b,d.a):h&&0!==H(c,f-1,e).a?(X(c,f,e,d.r,d.g,d.b,d.a),f+=1):g&&0!==H(c,f+1,e).a&&X(c,f,e,d.r,d.g,d.b,d.a)}return c},s=function(a){console.log(a)};window.requestAnimationFrame=
        window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;return t}();